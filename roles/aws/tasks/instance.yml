- block:
    - name: Create AWS Instance
      ec2:
        key_name: "{{ key_name }}"
        instance_type: "{{ instance_type }}"
        image: "{{ image }}"
        region: "{{ region }}"
        group: "{{ sec_group }}"
        vpc_subnet_id: "{{ vpc_subnet_id }}"
        assign_public_ip: yes
        wait: yes
        exact_count: 3
        count_tag:
          demo: demosrv
        instance_tags: 
          demo: demosrv
      register: myec2

    - name: Add new instance to host group
      add_host: hostname="{{ item.public_ip }}" groupname=tag_demo_demosrv
      with_items: "{{ myec2.instances }}"

    - name: Wait for SSH to come up
      wait_for: host="{{ item.public_dns_name }}" port=22 delay=30 timeout=320 state=started
      with_items: "{{ myec2.instances }}"
  tags: demo

- name: Terminate AWS Instance
  ec2:
    aws_access_key: "{{ aws_access_key }}"
    aws_secret_key: "{{ aws_secret_key }}"
    state: absent
    instance_id: "{{ instance_id }}"
  tags: instance-del
